<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WildLiveWatch ‚Äî Live Grid</title>

  <!-- Friendly jungle vibe -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071a14;         /* deep jungle */
      --fg:#f1fff9;         /* minty text */
      --card:#0e2a21;       /* card background */
      --stroke:rgba(255,255,255,.12);
      --accent:#25a4ff;     /* sky */
      --accent2:#12d49e;    /* mint */
      --mango:#ffb901;      /* mango */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 75% -10%, rgba(37,164,255,.22), transparent 60%),
        radial-gradient(900px 600px at 20% 110%, rgba(18,212,158,.18), transparent 60%),
        linear-gradient(180deg,#05140f,var(--bg));
    }

    /* Banner */
    .bannerWrap{padding:14px 14px 0}
    .banner{
      width:100%; height:auto; display:block; border-radius:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.35); border:1px solid var(--stroke);
    }

    /* Header + Nav */
    header{
      position:sticky; top:0; z-index:10;
      display:grid; grid-template-columns:1fr auto; align-items:center; gap:12px;
      padding:12px 18px; background:rgba(7,26,20,.88); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--stroke);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px}
    .brandMark{
      width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
      background:conic-gradient(from 120deg,var(--accent2),var(--accent),var(--mango));
      color:#052218; font-weight:900; box-shadow:0 6px 20px rgba(0,0,0,.35);
    }
    nav{display:flex; gap:10px; align-items:center}
    a.nav{
      text-decoration:none; color:var(--fg); font-weight:600; font-size:14px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
    }
    a.nav:hover{background:rgba(255,255,255,.12)}

    .controls{margin-left:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    select,button,input[type="range"]{
      appearance:none; border:1px solid var(--stroke);
      background:#0c221b; color:var(--fg); border-radius:12px; padding:8px 10px; font:inherit;
    }

    /* Grid */
    .grid{padding:18px; display:grid; gap:14px; grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .tile{
      position:relative; border-radius:18px; overflow:hidden; background:var(--card);
      border:1px solid var(--stroke); box-shadow:0 16px 40px rgba(0,0,0,.40);
      aspect-ratio:16/9; isolation:isolate;
    }
    .tile::before{
      content:""; position:absolute; inset:auto -20% -20% auto; width:55%; height:55%; transform:rotate(6deg);
      background:radial-gradient(closest-side, rgba(255,185,1,.14), transparent 70%); pointer-events:none; z-index:0;
    }
    .tile video{width:100%; height:100%; object-fit:cover; display:block; background:#000}

    .title{
      position:absolute; left:10px; top:10px; z-index:2; pointer-events:none; font-weight:700; font-size:14px;
      padding:6px 10px; border-radius:12px; color:#052218;
      background:linear-gradient(180deg,#2ef5c5,#1bdfab);
    }
    .overlay{position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:space-between; padding:10px;
      pointer-events:none; z-index:2; background:linear-gradient(180deg, transparent 65%, rgba(0,0,0,.45))}
    .leftStack{display:flex; gap:8px; align-items:center; pointer-events:auto}
    .badge{font-size:12px; padding:5px 8px; border-radius:999px; background:rgba(0,0,0,.55); border:1px solid var(--stroke)}
    .controlsBar{display:flex; align-items:center; gap:8px; pointer-events:auto}
    .iconBtn{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; cursor:pointer;
      background:rgba(0,0,0,.5); border:1px solid var(--stroke); color:var(--fg); transition:transform .08s, background .2s}
    .iconBtn:hover{transform:translateY(-1px); background:rgba(0,0,0,.6)}
    .range{width:130px; height:36px; display:inline-flex; align-items:center; padding:0 8px; gap:8px;
      border-radius:12px; background:rgba(0,0,0,.5); border:1px solid var(--stroke)}
    .range input{width:100%; background:transparent}

    .floatingHint{position:absolute; inset:0; display:grid; place-items:center; color:#e9fff7; pointer-events:none; z-index:1;
      opacity:0; transition:opacity .25s; text-shadow:0 2px 10px rgba(0,0,0,.6)}
    .tile.initial .floatingHint{opacity:1}

    footer{opacity:.8; padding: 0 18px 24px; text-align:center; font-size:12px}
  </style>
</head>
<body>
  <!-- Responsive banner -->
  <div class="bannerWrap">
    <picture>
      <source media="(max-width: 768px)" srcset="./mobile_banner.webp">
      <img class="banner" src="./desktop_banner.webp" alt="WildLiveWatch ‚Äî safari friends in a Madagascar sunset">
    </picture>
  </div>

  <header>
    <div class="brand">
      <div class="brandMark">üêæ</div>
      <div><span style="font-weight:700;">Wild</span>LiveWatch</div>
    </div>
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-self:end;">
      <nav>
        <a class="nav" href="/index.html">Home</a>
        <a class="nav" href="/gallery.html">Gallery</a>
        <a class="nav" href="/about.html">About</a>
        <a class="nav" href="/contact.html">Contact</a>
      </nav>
      <div class="controls">
        <label for="tileCount">Tiles:</label>
        <select id="tileCount">
          <option value="4">4</option>
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
        <button id="pauseAll">Pause all</button>
        <button id="playAll">Play all</button>
        <button id="muteAll">Mute all</button>
      </div>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <footer>
    Tip: Most browsers only allow <em>autoplay</em> when the video is <strong>muted</strong>. Click a tile to unmute it
    (only one tile has sound at a time).
  </footer>

  <template id="tileTpl">
    <article class="tile initial" data-id="">
      <div class="title"></div>
      <div class="media-slot" aria-label="Live camera feed"></div>
      <div class="floatingHint">Click to unmute üîä</div>
      <div class="overlay">
        <div class="leftStack">
          <span class="badge status">LIVE</span>
          <span class="badge latency" title="Mock latency">~2s</span>
        </div>
        <div class="controlsBar">
          <button class="iconBtn btnMute" title="Toggle mute">üîá</button>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input class="vol" type="range" min="0" max="1" step="0.01" value="0.5" />
          </div>
          <button class="iconBtn btnPlay" title="Play / Pause">‚èØ</button>
          <button class="iconBtn btnFs" title="Fullscreen">‚õ∂</button>
        </div>
      </div>
    </article>
  </template>

  <!-- HLS support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  // --- Config ---
  const CSV_URL = "https://raw.githubusercontent.com/ZeriahStudios/wildlivewatch/main/Website%20URL.csv";
  const DEFAULT_TILES = 6;

  // --- Helpers ---
  const isHls = url => /\.m3u8($|\?)/i.test(url);
  const isMp4 = url => /\.mp4($|\?)/i.test(url);
  const isYouTube = url => /youtube\.com|youtu\.be/i.test(url);

  // Robust-ish CSV parser (handles quotes and commas per RFC4180 basics)
  function parseCSV(text) {
    const rows = [];
    let cur = [], field = '', inQuotes = false, i = 0;

    while (i < text.length) {
      const c = text[i];

      if (inQuotes) {
        if (c === '"') {
          if (text[i + 1] === '"') { field += '"'; i += 2; continue; } // escaped quote
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }

      if (c === '"') { inQuotes = true; i++; continue; }
      if (c === ',') { cur.push(field.trim()); field = ''; i++; continue; }
      if (c === '\r') { i++; continue; }
      if (c === '\n') { cur.push(field.trim()); rows.push(cur); cur = []; field = ''; i++; continue; }

      field += c; i++;
    }
    // push last field/row
    if (field.length || cur.length) { cur.push(field.trim()); rows.push(cur); }

    // map headers
    if (!rows.length) return [];
    const headers = rows[0].map(h => h.trim());
    return rows.slice(1)
      .filter(r => r.some(v => (v && String(v).trim().length))) // drop empty lines
      .map(r => Object.fromEntries(headers.map((h, idx) => [h, r[idx] ? r[idx].trim() : ""])));
  }

  async function loadStreamsFromCSV() {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
    const text = await res.text();
    const rows = parseCSV(text);

    // Try to be flexible with header names
    return rows.map(r => {
      const name = r.Name || r.Title || r.name || r.title || "Untitled";
      const url  = r.URL  || r.Url   || r.url   || r.link  || "";
      const poster = r.Poster || r.poster || "";
      return { title: name, src: url, poster };
    }).filter(x => x.src);
  }

  // --- DOM things from your page ---
  const grid = document.getElementById('grid');
  const tileCountSel = document.getElementById('tileCount');
  const btnPauseAll = document.getElementById('pauseAll');
  const btnPlayAll  = document.getElementById('playAll');
  const btnMuteAll  = document.getElementById('muteAll');
  let tiles = []; // {el, type, video?, iframe?}

  function attachVideoSource(video, url){
    if (isHls(url)) {
      if (window.Hls && Hls.isSupported()){
        const hls = new Hls({lowLatencyMode:true});
        hls.loadSource(url);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
      }
    } else {
      video.src = url;
    }
  }

  function createMediaNode(container, stream) {
    if (isYouTube(stream.src)) {
      // Convert watch links to embed if needed
      let src = stream.src;
      if (src.includes("watch?v=")) {
        const id = src.split("watch?v=")[1].split("&")[0];
        src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&controls=1&modestbranding=1&rel=0`;
      } else if (src.includes("youtu.be/")) {
        const id = src.split("youtu.be/")[1].split(/[?&]/)[0];
        src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&controls=1&modestbranding=1&rel=0`;
      }

      const iframe = document.createElement("iframe");
      iframe.src = src;
      iframe.allow = "autoplay; encrypted-media; picture-in-picture";
      iframe.referrerPolicy = "strict-origin-when-cross-origin";
      iframe.style.width = "100%";
      iframe.style.height = "100%";
      iframe.setAttribute("frameborder", "0");
      container.appendChild(iframe);

      return { type: "youtube", iframe };
    }

    // Fallback: video element (MP4/HLS)
    const video = document.createElement("video");
    video.playsInline = true;
    video.muted = true;
    video.autoplay = true;
    video.loop = true;
    video.preload = "metadata";
    if (stream.poster) video.poster = stream.poster;
    video.style.width = "100%";
    video.style.height = "100%";
    video.style.objectFit = "cover";

    container.appendChild(video);
    attachVideoSource(video, stream.src);
    return { type: "video", video };
  }

  function updateBtns(el, type, video){
    const muteBtn = el.querySelector('.btnMute');
    const playBtn = el.querySelector('.btnPlay');

    if (type === "video") {
      muteBtn.textContent = (video.muted ? 'üîá' : 'üîä');
      playBtn.textContent = (video.paused ? '‚ñ∂' : '‚è∏');
      muteBtn.disabled = false; playBtn.disabled = false;
    } else {
      // YouTube: we don‚Äôt wire buttons (YouTube has its own controls)
      muteBtn.textContent = 'üîá'; muteBtn.disabled = true;
      playBtn.textContent = '‚ñ∂';  playBtn.disabled = true;
      const volWrap = el.querySelector('.range'); if (volWrap) volWrap.style.display = 'none';
    }
  }

  function toggleMute(targetEl, keepMuted){
    tiles.forEach(({el, type, video})=>{
      if (type !== "video") return; // only for real video elements
      if (el === targetEl) {
        video.muted = keepMuted;
        if (!keepMuted){ video.muted=false; video.play().catch(()=>{}); }
      } else {
        video.muted = true;
      }
      updateBtns(el, type, video);
    });
  }

  function attachTileInteractions(node, type, video){
    node.addEventListener('click', e => {
      if (e.target.closest('.controlsBar')) return;
      if (type === "video") toggleMute(node, false);
    });

    const muteBtn = node.querySelector('.btnMute');
    const playBtn = node.querySelector('.btnPlay');
    const fsBtn   = node.querySelector('.btnFs');
    const vol     = node.querySelector('.vol');

    if (muteBtn) muteBtn.addEventListener('click', e => {
      e.stopPropagation();
      if (type === "video") toggleMute(node, video.muted);
    });

    if (playBtn) playBtn.addEventListener('click', e => {
      e.stopPropagation();
      if (type === "video") {
        if (video.paused) video.play(); else video.pause();
        updateBtns(node, type, video);
      }
    });

    if (fsBtn) fsBtn.addEventListener('click', e => {
      e.stopPropagation();
      if (document.fullscreenElement) document.exitFullscreen();
      else node.requestFullscreen().catch(()=>{});
    });

    if (vol) vol.addEventListener('input', e => {
      if (type !== "video") return;
      video.volume = parseFloat(e.target.value);
      if (video.muted && video.volume > 0) toggleMute(node, false);
    });

    if (type === "video") {
      video.addEventListener('play', () => node.classList.remove('initial'));
      node.addEventListener('pointerdown', () => { if (video.paused) video.play().catch(()=>{}); });
    } else {
      // YouTube: remove initial hint immediately
      node.classList.remove('initial');
    }
  }

  function renderTiles(streams, n){
    grid.innerHTML=''; tiles=[];
    const tpl = document.getElementById('tileTpl');

    for (let i=0;i<n;i++){
      const data = streams[i % streams.length];
      const node = tpl.content.firstElementChild.cloneNode(true);

      node.querySelector('.title').textContent = data.title || 'Untitled';
      const mediaSlot = node.querySelector('.media-slot');

      const media = createMediaNode(mediaSlot, data);
      const video = media.video || null;

      attachTileInteractions(node, media.type, video);
      grid.appendChild(node);

      tiles.push({ el: node, type: media.type, video, iframe: media.iframe || null });
      updateBtns(node, media.type, video);
    }
  }

  // Global controls
  tileCountSel.addEventListener('change', ()=>{
    const n = parseInt(tileCountSel.value, 10);
    renderTiles(window._STREAMS || [], n);
  });
  btnPauseAll.addEventListener('click', ()=> tiles.forEach(t=>{
    if (t.type === "video") { t.video.pause(); updateBtns(t.el, t.type, t.video); }
  }));
  btnPlayAll .addEventListener('click', ()=> tiles.forEach(t=>{
    if (t.type === "video") { t.video.play().catch(()=>{}); updateBtns(t.el, t.type, t.video); }
  }));
  btnMuteAll .addEventListener('click', ()=> tiles.forEach(t=>{
    if (t.type === "video") { t.video.muted = true; updateBtns(t.el, t.type, t.video); }
  }));

  // Boot
  (async function init(){
    let streams = [];
    try {
      streams = await loadStreamsFromCSV();
    } catch (e) {
      console.warn("CSV load failed, using demo streams.", e);
      // Fallback demo streams (your originals)
      streams = [
        { title: "Savannah Cam",     src: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" },
        { title: "Forest Waterhole", src: "https://test-streams.mux.dev/test_001/stream.m3u8" },
        { title: "Cliff Rookery",    src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        { title: "River Bend",       src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        { title: "Desert Den",       src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        { title: "Rainforest Canopy",src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        { title: "Mountain Pass",    src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        { title: "Delta Marsh",      src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
      ];
    }

    // Save globally for re-render on tile count change
    window._STREAMS = streams;

    // Set tile count dropdown smartly (cap options to streams length)
    const total = streams.length || DEFAULT_TILES;
    // Keep your original options but adjust selection:
    tileCountSel.value = String(Math.min(DEFAULT_TILES, total));
    renderTiles(streams, parseInt(tileCountSel.value, 10));
  })();
</script>

</body>
</html>
