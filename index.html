<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WildLiveWatch ‚Äî Live Grid</title>

  <!-- Friendly jungle vibe -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071a14;         /* deep jungle */
      --fg:#f1fff9;         /* minty text */
      --card:#0e2a21;       /* card background */
      --stroke:rgba(255,255,255,.12);
      --accent:#25a4ff;     /* sky */
      --accent2:#12d49e;    /* mint */
      --mango:#ffb901;      /* mango */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 75% -10%, rgba(37,164,255,.22), transparent 60%),
        radial-gradient(900px 600px at 20% 110%, rgba(18,212,158,.18), transparent 60%),
        linear-gradient(180deg,#05140f,var(--bg));
    }

    /* Banner */
    .bannerWrap{padding:14px 14px 0}
    .banner{
      width:100%; height:auto; display:block; border-radius:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.35); border:1px solid var(--stroke);
    }

    /* Header + Nav */
    header{
      position:sticky; top:0; z-index:10;
      display:grid; grid-template-columns:1fr auto; align-items:center; gap:12px;
      padding:12px 18px; background:rgba(7,26,20,.88); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--stroke);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px}
    nav{display:flex; gap:10px; align-items:center}
    a.nav{
      text-decoration:none; color:var(--fg); font-weight:600; font-size:14px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
    }
    a.nav:hover{background:rgba(255,255,255,.12)}

    .controls{margin-left:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    select,button,input[type="range"]{
      appearance:none; border:1px solid var(--stroke);
      background:#0c221b; color:var(--fg); border-radius:12px; padding:8px 10px; font:inherit;
    }
    .status-badge{
      display:inline-block; margin-left:8px; padding:5px 8px; border-radius:999px; 
      background:rgba(0,0,0,.55); border:1px solid var(--stroke); font-size:12px;
    }

    /* Grid */
    .grid{padding:18px; display:grid; gap:14px; grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .tile{
      position:relative; border-radius:18px; overflow:hidden; background:var(--card);
      border:1px solid var(--stroke); box-shadow:0 16px 40px rgba(0,0,0,.40);
      aspect-ratio:16/9; isolation:isolate;
    }
    .tile::before{
      content:""; position:absolute; inset:auto -20% -20% auto; width:55%; height:55%; transform:rotate(6deg);
      background:radial-gradient(closest-side, rgba(255,185,1,.14), transparent 70%); pointer-events:none; z-index:0;
    }
    .tile video{width:100%; height:100%; object-fit:cover; display:block; background:#000}

    .title{
      position:absolute; left:10px; top:10px; z-index:2; pointer-events:none; font-weight:700; font-size:14px;
      padding:6px 10px; border-radius:12px; color:#052218;
      background:linear-gradient(180deg,#2ef5c5,#1bdfab);
    }
    .overlay{position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:space-between; padding:10px;
      pointer-events:none; z-index:2; background:linear-gradient(180deg, transparent 65%, rgba(0,0,0,.45))}
    .leftStack{display:flex; gap:8px; align-items:center; pointer-events:auto}
    .badge{font-size:12px; padding:5px 8px; border-radius:999px; background:rgba(0,0,0,.55); border:1px solid var(--stroke)}
    .controlsBar{display:flex; align-items:center; gap:8px; pointer-events:auto}
    .iconBtn{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; cursor:pointer;
      background:rgba(0,0,0,.5); border:1px solid var(--stroke); color:var(--fg); transition:transform .08s, background .2s}
    .iconBtn:hover{transform:translateY(-1px); background:rgba(0,0,0,.6)}
    .range{width:130px; height:36px; display:inline-flex; align-items:center; padding:0 8px; gap:8px;
      border-radius:12px; background:rgba(0,0,0,.5); border:1px solid var(--stroke)}
    .range input{width:100%; background:transparent}

    .floatingHint{position:absolute; inset:0; display:grid; place-items:center; color:#e9fff7; pointer-events:none; z-index:1;
      opacity:0; transition:opacity .25s; text-shadow:0 2px 10px rgba(0,0,0,.6)}
    .tile.initial .floatingHint{opacity:1}

    footer{opacity:.8; padding: 0 18px 24px; text-align:center; font-size:12px}
  </style>
</head>
<body>
  <!-- Responsive banner (R2 URL) -->
  <div class="bannerWrap">
    <picture>
      <source media="(max-width: 768px)" srcset="https://assets.wildlivewatch.com/wildlivewatch_banner.webp">
      <img class="banner" src="https://assets.wildlivewatch.com/wildlivewatch_banner.webp"
           alt="WildLiveWatch ‚Äî safari friends in a Madagascar sunset">
    </picture>
  </div>

  <header>
    <div class="brand">
      <img src="https://assets.wildlivewatch.com/word_mark.webp" alt="WildLiveWatch Logo" style="height:36px; border-radius:8px;" />
    </div>
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-self:end;">
      <nav>
        <a class="nav" href="/index.html">Home</a>
        <a class="nav" href="/gallery.html">Gallery</a>
        <a class="nav" href="/about.html">About</a>
        <a class="nav" href="/contact.html">Contact</a>
      </nav>
      <div class="controls">
        <label for="tileCount">Tiles:</label>
        <select id="tileCount">
          <option value="4">4</option>
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
        <button id="pauseAll">Pause all</button>
        <button id="playAll">Play all</button>
        <button id="muteAll">Mute all</button>
        <span id="statusBadge" class="status-badge">Loading‚Ä¶</span>
      </div>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <footer>
    Tip: Most browsers only allow <em>autoplay</em> when the video is <strong>muted</strong>. Click a tile to unmute it
    (only one tile has sound at a time).
  </footer>

  <template id="tileTpl">
    <article class="tile initial" data-id="">
      <div class="title"></div>
      <div class="media-slot" aria-label="Live camera feed"></div>
      <div class="floatingHint">Click to unmute üîä</div>
      <div class="overlay">
        <div class="leftStack">
          <span class="badge status">LIVE</span>
          <span class="badge latency" title="Mock latency">~2s</span>
        </div>
        <div class="controlsBar">
          <button class="iconBtn btnMute" title="Toggle mute">üîá</button>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input class="vol" type="range" min="0" max="1" step="0.01" value="0.5" />
          </div>
          <button class="iconBtn btnPlay" title="Play / Pause">‚èØ</button>
          <button class="iconBtn btnFs" title="Fullscreen">‚õ∂</button>
        </div>
      </div>
    </article>
  </template>

  <!-- HLS support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // 1) Your CSV (GitHub raw)
    const CSV_URL = "https://raw.githubusercontent.com/ZeriahStudios/wildlivewatch/main/Website%20URL.csv";

    // Helpers
    const isHls = u => /\.m3u8($|\?)/i.test(u);
    const isYouTube = u => /youtube\.com|youtu\.be/i.test(u);

    function parseCSV(text){
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let cur=[], field='', inQ=false, i=0;
      while (i<text.length){
        const c=text[i];
        if (inQ){
          if (c === '"'){ if (text[i+1] === '"'){ field+='"'; i+=2; continue; } inQ=false; i++; continue; }
          field += c; i++; continue;
        }
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ','){ cur.push(field.trim()); field=''; i++; continue; }
        if (c === '\r'){ i++; continue; }
        if (c === '\n'){ cur.push(field.trim()); rows.push(cur); cur=[]; field=''; i++; continue; }
        field += c; i++;
      }
      if (field.length || cur.length){ cur.push(field.trim()); rows.push(cur); }
      if (!rows.length) return [];
      const headers = rows[0].map(h=>h.trim());
      return rows.slice(1)
        .filter(r => r.some(v => v && String(v).trim().length))
        .map(r => Object.fromEntries(headers.map((h,idx)=>[h, r[idx]?r[idx].trim():''])));
    }

    function cleanSrcLike(value){
      // Accept raw URL or strings like: src="https://..." or src='https://...'
      if (!value) return "";
      let v = value.trim();
      if (v.startsWith('src=')){
        v = v.replace(/^src=\s*['"]?/i, '').replace(/['"]\s*$/,'');
      }
      return v;
    }

    async function loadStreamsFromCSV(){
      const res = await fetch(CSV_URL + `?t=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error("CSV fetch failed: " + res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      return rows.map(r => {
        const name = r.Name || r.Title || r.Channel || r.channel || "Untitled";
        const urlRaw = r.URL || r.Url || r.url || r.link || r.VideoURL || r.videoURL || r.videourl || "";
        const poster = r.Poster || r.poster || r.FrameURL || r.frameURL || "";
        const url = cleanSrcLike(urlRaw);
        return { title: name, src: url, poster };
      }).filter(x => x.src);
    }

    const grid = document.getElementById('grid');
    const tileCountSel = document.getElementById('tileCount');
    const btnPauseAll = document.getElementById('pauseAll');
    const btnPlayAll  = document.getElementById('playAll');
    const btnMuteAll  = document.getElementById('muteAll');
    const statusBadge = document.getElementById('statusBadge');
    let tiles = [];

    function createMediaNode(container, stream){
      if (isYouTube(stream.src)){
        let src = stream.src;

        // Normalize common YouTube formats ‚Üí embed
        if (src.includes("watch?v=")){
          const id = src.split("watch?v=")[1].split("&")[0];
          src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&controls=1&modestbranding=1&rel=0`;
        } else if (src.includes("youtu.be/")){
          const id = src.split("youtu.be/")[1].split(/[?&]/)[0];
          src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&controls=1&modestbranding=1&rel=0`;
        } else if (!/\/embed\//.test(src)) {
          // Last resort: try to extract v= if present
          const m = src.match(/[?&]v=([^&]+)/);
          if (m && m[1]) {
            src = `https://www.youtube.com/embed/${m[1]}?autoplay=1&mute=1&playsinline=1&controls=1&modestbranding=1&rel=0`;
          }
        }

        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.allow = "autoplay; encrypted-media; picture-in-picture";
        iframe.referrerPolicy = "strict-origin-when-cross-origin";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.setAttribute("frameborder","0");
        container.appendChild(iframe);
        return { type:'youtube', iframe };
      }

      const video = document.createElement('video');
      video.playsInline = true; video.muted = true; video.autoplay = true; video.loop = true; video.preload = 'metadata';
      if (stream.poster) video.poster = stream.poster;
      video.style.width = "100%"; video.style.height = "100%"; video.style.objectFit = "cover";
      container.appendChild(video);

      if (isHls(stream.src) && window.Hls && Hls.isSupported()){
        const hls = new Hls({lowLatencyMode:true});
        hls.loadSource(stream.src); hls.attachMedia(video);
      } else {
        video.src = stream.src;
      }
      return { type:'video', video };
    }

    function updateBtns(el, type, video){
      const muteBtn = el.querySelector('.btnMute');
      const playBtn = el.querySelector('.btnPlay');
      const volWrap = el.querySelector('.range');
      if (type === 'video'){
        muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
        playBtn.textContent = video.paused ? '‚ñ∂' : '‚è∏';
        muteBtn.disabled = false; playBtn.disabled = false;
        if (volWrap) volWrap.style.display = '';
      } else {
        muteBtn.textContent = 'üîá'; playBtn.textContent = '‚ñ∂';
        muteBtn.disabled = true; playBtn.disabled = true;
        if (volWrap) volWrap.style.display = 'none';
      }
    }

    function toggleMute(target, keepMuted){
      tiles.forEach(({el,type,video})=>{
        if (type !== 'video') return;
        if (el === target){
          if (!keepMuted){ video.muted = false; video.play().catch(()=>{}); }
        } else { video.muted = true; }
        updateBtns(el,type,video);
      });
    }

    function attachTileInteractions(node, type, video){
      node.addEventListener('click', e => {
        if (e.target.closest('.controlsBar')) return;
        if (type === 'video') toggleMute(node, false);
      });
      const muteBtn = node.querySelector('.btnMute');
      const playBtn = node.querySelector('.btnPlay');
      const fsBtn   = node.querySelector('.btnFs');
      const vol     = node.querySelector('.vol');
      if (muteBtn) muteBtn.addEventListener('click', e => { e.stopPropagation(); if (type==='video') toggleMute(node, video.muted); });
      if (playBtn) playBtn.addEventListener('click', e => { e.stopPropagation(); if (type==='video'){ if (video.paused) video.play(); else video.pause(); updateBtns(node,type,video);} });
      if (fsBtn)   fsBtn.addEventListener('click', e => { e.stopPropagation(); if (document.fullscreenElement) document.exitFullscreen(); else node.requestFullscreen().catch(()=>{}); });
      if (vol)     vol.addEventListener('input', e => { if (type!=='video') return; video.volume = parseFloat(e.target.value); if (video.muted && video.volume>0) toggleMute(node,false); });
      if (type === 'video'){ video.addEventListener('play', ()=> node.classList.remove('initial')); node.addEventListener('pointerdown', ()=>{ if (video.paused) video.play().catch(()=>{}); }); }
      else { node.classList.remove('initial'); }
    }

    function renderTiles(streams, n){
      grid.innerHTML = ''; tiles = [];
      const tpl = document.getElementById('tileTpl');
      for (let i=0;i<n && streams.length;i++){
        const data = streams[i % streams.length];
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.title').textContent = data.title || 'Untitled';
        const slot = node.querySelector('.media-slot');
        const media = createMediaNode(slot, data);
        const video = media.video || null;
        attachTileInteractions(node, media.type, video);
        grid.appendChild(node);
        tiles.push({ el: node, type: media.type, video, iframe: media.iframe || null });
        updateBtns(node, media.type, video);
      }
      if (!streams.length){
        const p = document.createElement('p');
        p.textContent = "No streams found in CSV.";
        p.style.opacity = .8; p.style.textAlign = 'center';
        grid.appendChild(p);
      }
    }

    tileCountSel.addEventListener('change', ()=> renderTiles(window._STREAMS || [], parseInt(tileCountSel.value,10)));

    btnPauseAll.addEventListener('click', ()=> tiles.forEach(t=>{ if (t.type==='video'){ t.video.pause(); updateBtns(t.el,t.type,t.video);} }));
    btnPlayAll .addEventListener('click', ()=> tiles.forEach(t=>{ if (t.type==='video'){ t.video.play().catch(()=>{}); updateBtns(t.el,t.type,t.video);} }));
    btnMuteAll .addEventListener('click', ()=> tiles.forEach(t=>{ if (t.type==='video'){ t.video.muted = true; updateBtns(t.el,t.type,t.video);} }));

    (async function init(){
      try {
        const streams = await loadStreamsFromCSV();
        window._STREAMS = streams;
        statusBadge.textContent = `CSV ‚úÖ ${streams.length}`;
        const initial = Math.min(parseInt(tileCountSel.value,10) || 6, streams.length || 6);
        tileCountSel.value = String(initial);
        renderTiles(streams, initial);
      } catch (e) {
        console.warn('CSV load failed, using demo streams.', e);
        statusBadge.textContent = 'CSV ‚ùå demo';
        const demo = [
          { title: "Savannah Cam",     src: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" },
          { title: "Forest Waterhole", src: "https://test-streams.mux.dev/test_001/stream.m3u8" },
          { title: "Cliff Rookery",    src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
          { title: "River Bend",       src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
          { title: "Desert Den",       src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
          { title: "Rainforest Canopy",src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        ];
        window._STREAMS = demo;
        renderTiles(demo, parseInt(tileCountSel.value,10) || 6);
      }
    })();
  </script>
</body>
</html>
