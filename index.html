// src/index.js
import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import axios from "axios";
import { fetchYouTubeLive } from "./adapters/youtube.js";

dotenv.config();

// ESM-safe __dirname / __filename (define these BEFORE using them)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());

// Serve the /public folder (so / loads public/index.html if present)
const publicDir = path.join(__dirname, "..", "public");
app.use(express.static(publicDir));

// --- Load seed channel IDs (fallback to empty list if file missing)
const seedPath = path.join(__dirname, "seed_channels.json");
let seed = { youtube_channel_ids: [] };
try {
  seed = JSON.parse(fs.readFileSync(seedPath, "utf-8"));
} catch {
  console.warn("[seed] src/seed_channels.json not found or invalid JSON â€” using empty list");
}

let CACHE = { streams: [], updatedAt: null };

async function discoverAll() {
  const yt = await fetchYouTubeLive({
    apiKey: process.env.YT_API_KEY,
    channelIds: seed.youtube_channel_ids,
  });

  CACHE = { streams: yt, updatedAt: new Date().toISOString() };
  return CACHE;
}

// --- Find channels by name -> returns channelId list (handy helper)
app.get("/api/find-channels", async (req, res) => {
  try {
    const q = req.query.q || "";
    if (!q) return res.status(400).json({ error: "Missing ?q=search term" });

    const { data } = await axios.get("https://www.googleapis.com/youtube/v3/search", {
      params: {
        part: "snippet",
        q,
        type: "channel",
        maxResults: 10,
        key: process.env.YT_API_KEY,
      },
    });

    const items = (data.items || []).map((it) => ({
      channelId: it.id?.channelId,
      title: it.snippet?.title,
      url: `https://www.youtube.com/channel/${it.id?.channelId}`,
    }));

    res.json({ query: q, items });
  } catch (err) {
    console.error("find-channels error:", err?.response?.data || err.message);
    res.status(500).json({ error: "Failed to search channels" });
  }
});

// --- Streams API with simple cache (60s)
app.get("/api/streams", async (_req, res) => {
  const stale = !CACHE.updatedAt || Date.now() - Date.parse(CACHE.updatedAt) > 60_000;
  if (stale) {
    try {
      await discoverAll();
    } catch (e) {
      console.error("Discovery error:", e.message);
    }
  }
  res.json(CACHE);
});

// NOTE: No explicit app.get("/") route here.
// If public/index.html exists, it will be served by express.static above.

const port = process.env.PORT || 8080;
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
  discoverAll();
  setInterval(discoverAll, 60_000);
});
